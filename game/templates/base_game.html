<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
    integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

  <link rel="stylesheet" type='text/css' href="/static/chessboardjs/css/chessboard-1.0.0.css">
  <title>
    {% block title %}

    {% endblock %}
  </title>


  <style>
    body {
      background-color: #212121;
      color: white;
    }
  </style>
</head>

<body>
  <!-- navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#">Chess Mate</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
      aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item active">
          <a class="nav-link" href="{{url_for('home')}}">Home <span class="sr-only">(current)</span></a>
        </li>


      </ul>


      <ul class="navbar-nav ml-auto">
        <li class="nav-item active">
          <a class="nav-link" href="{{url_for('login_page')}}">Login <span class="sr-only">(current)</span></a>
        </li>

        <li class="nav-item active">
          <a class="nav-link" href="{{url_for('register_page')}}">Register <span class="sr-only"></span></a>
        </li>
      </ul>

    </div>
  </nav>
  {% block content %}


  {% endblock %}




  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <script src="/static/chessjs/chess.js"></script>
  <script src="/static/chessboardjs/js/chessboard-1.0.0.js"></script>

  <script src="/static/socketio-client/socket.io.js"></script>



  <script>

    $(document).ready(function () {

      var board = null
      var game = new Chess()
      var $status = $('#status')
      var $fen = $('#fen')
      var $pgn = $('#pgn')
      var whiteSquareGrey = '#a9a9a9'
      var blackSquareGrey = '#696969'
      var multiPlayer = false;

      function removeGreySquares() {
        $('#chess_board .square-55d63').css('background', '')
      }

      function greySquare(square) {
        var $square = $('#chess_board .square-' + square)

        var background = whiteSquareGrey
        if ($square.hasClass('black-3c85d')) {
          background = blackSquareGrey
        }

        $square.css('background', background)
      }


      function onDragStart(source, piece, position, orientation) {
        // do not pick up pieces if the game is over
        if (game.game_over()) return false

        // only pick up pieces for the side to move
        if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
          (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
          return false
        }
      }

      function onDrop(source, target) {

        removeGreySquares()

        // see if the move is legal
        var move = game.move({
          from: source,
          to: target,
          promotion: 'q' // NOTE: always promote to a queen for example simplicity
        })
        console.log(move)
        // illegal move
        if (move === null) {

          return 'snapback'

        } else if (multiPlayer) {
          socket.emit("move", move);
        }



        // make post request to get api
        $.post('/make_move', { 'fen': game.fen() }, function (data) {
          //load fen into current board state
          game.move(data.best_move, { sloppy: true });

          // update board position
          board.position(game.fen());
          updateStatus()
        });

        updateStatus()
      }

      function onMouseoverSquare(square, piece) {
        // get list of possible moves for this square
        var moves = game.moves({
          square: square,
          verbose: true
        })

        // exit if there are no moves available for this square
        if (moves.length === 0) return

        // highlight the square they moused over
        greySquare(square)

        // highlight the possible squares for this piece
        for (var i = 0; i < moves.length; i++) {
          greySquare(moves[i].to)
        }
      }

      function onMouseoutSquare(square, piece) {
        removeGreySquares()
      }


      // update the board position after the piece snap
      // for castling, en passant, pawn promotion
      function onSnapEnd() {
        board.position(game.fen())
      }

      function updateStatus() {
        var status = ''

        var moveColor = 'White'
        if (game.turn() === 'b') {
          moveColor = 'Black'
        }

        // checkmate?
        if (game.in_checkmate()) {
          status = 'Game over, ' + moveColor + ' is in checkmate.'
        }

        // draw?
        else if (game.in_draw()) {
          status = 'Game over, drawn position'
        }

        // game still on
        else {
          status = moveColor + ' to move'

          // check?
          if (game.in_check()) {
            status += ', ' + moveColor + ' is in check'
          }
        }

        $status.html(status)
        $fen.html(game.fen())
        $pgn.html(game.pgn())
      }

      var config = {
        draggable: true,
        position: 'start',
        onDragStart: onDragStart,
        onDrop: onDrop,
        onMouseoutSquare: onMouseoutSquare,
        onMouseoverSquare: onMouseoverSquare,
        onSnapEnd: onSnapEnd
      }
      board = Chessboard('chess_board', config)

      updateStatus()



      // setup my socket client


      const startMultiPlayer = function () {
        var socket = io(5000);

        window.onclick = function (e) {
          socket.emit('message', 'socket working rld!');
        };

        socket.on('move', function (msg) {
          game.move(msg);
          board.position(game.fen()); // fen is the board layout
        });

      }

    })

  </script>


</body>

</html>